{
  "feature": "Feed Image Proxy with Hotlink Protection Bypass",
  "workflow_type": "feature",
  "workflow_rationale": "This is a new feature implementation adding PHP image proxy infrastructure and React error handling components. Not a bug fix - the current behavior (hiding broken images) works as designed.",
  "phases": [
    {
      "id": "phase-1-backend-infrastructure",
      "name": "Backend Infrastructure",
      "type": "setup",
      "description": "Create cache directory and basic image proxy endpoint structure",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create image cache directory with .gitkeep",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["api/cache/images/.gitkeep"],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "ls -la api/cache/images/",
            "expected": "Directory exists with .gitkeep file"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-2-backend-proxy",
      "name": "Backend Image Proxy",
      "type": "implementation",
      "description": "Build PHP image proxy endpoint with security validation and caching",
      "depends_on": ["phase-1-backend-infrastructure"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create image-proxy.php with basic URL validation and cURL fetching",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["api/feeds/image-proxy.php"],
          "patterns_from": ["api/feeds/recipes.php", "api/feeds/fetch.php"],
          "verification": {
            "type": "command",
            "command": "php -l api/feeds/image-proxy.php",
            "expected": "No syntax errors detected"
          },
          "status": "pending",
          "notes": "Include: URL validation (http/https only), SSRF prevention (block internal IPs), MIME type verification, proper Referer header for hotlink bypass"
        },
        {
          "id": "subtask-2-2",
          "description": "Add filesystem caching to image proxy with hash-based filenames",
          "service": "main",
          "files_to_modify": ["api/feeds/image-proxy.php"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "php -l api/feeds/image-proxy.php",
            "expected": "No syntax errors detected"
          },
          "status": "pending",
          "notes": "Cache with md5($url).extension format. Check cache first, serve if exists. Set appropriate cache TTL (24 hours). Handle unwritable cache gracefully."
        }
      ]
    },
    {
      "id": "phase-3-frontend-component",
      "name": "Frontend FeedImage Component",
      "type": "implementation",
      "description": "Create reusable React component with state-based error handling and fallback UI",
      "depends_on": ["phase-1-backend-infrastructure"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add getProxiedImageUrl helper function to api.ts",
          "service": "main",
          "files_to_modify": ["src/services/api.ts"],
          "files_to_create": [],
          "patterns_from": ["src/services/api.ts"],
          "verification": {
            "type": "command",
            "command": "npx tsc --noEmit src/services/api.ts 2>&1 || echo 'Type check complete'",
            "expected": "No TypeScript errors"
          },
          "status": "pending",
          "notes": "Function should return proxied URL using API_BASE. Handle null/undefined URLs by returning empty string or null."
        },
        {
          "id": "subtask-3-2",
          "description": "Create FeedImage React component with error state handling",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["src/components/common/FeedImage.tsx"],
          "patterns_from": ["src/components/widgets/news/NewsWidget.tsx"],
          "verification": {
            "type": "command",
            "command": "npx tsc --noEmit src/components/common/FeedImage.tsx 2>&1 || echo 'Type check complete'",
            "expected": "No TypeScript errors"
          },
          "status": "pending",
          "notes": "Props: src, alt, className, fallbackElement. Use useState for error state. Use getProxiedImageUrl. Include loading='lazy' attribute."
        },
        {
          "id": "subtask-3-3",
          "description": "Create unit tests for FeedImage component",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["src/components/common/FeedImage.test.tsx"],
          "patterns_from": ["src/components/ui/Button.test.tsx"],
          "verification": {
            "type": "command",
            "command": "npm test -- --run src/components/common/FeedImage.test.tsx",
            "expected": "All tests pass"
          },
          "status": "pending",
          "notes": "Test cases: renders with src, shows fallback on error, handles null src, applies className"
        },
        {
          "id": "subtask-3-4",
          "description": "Add unit tests for getProxiedImageUrl function",
          "service": "main",
          "files_to_modify": ["src/services/api.test.ts"],
          "files_to_create": [],
          "patterns_from": ["src/services/api.test.ts"],
          "verification": {
            "type": "command",
            "command": "npm test -- --run src/services/api.test.ts",
            "expected": "All tests pass"
          },
          "status": "pending",
          "notes": "Test cases: returns correct proxy URL, encodes URL properly, handles null/undefined"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "NewsWidget Integration",
      "type": "integration",
      "description": "Integrate FeedImage component into NewsWidget and verify end-to-end functionality",
      "depends_on": ["phase-2-backend-proxy", "phase-3-frontend-component"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Update NewsWidget to use FeedImage component with proxied URLs",
          "service": "main",
          "files_to_modify": ["src/components/widgets/news/NewsWidget.tsx"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npx tsc --noEmit src/components/widgets/news/NewsWidget.tsx 2>&1 || echo 'Type check complete'",
            "expected": "No TypeScript errors"
          },
          "status": "pending",
          "notes": "Replace inline img + onError with FeedImage component. Pass appropriate fallback element (bullet point span)."
        },
        {
          "id": "subtask-4-2",
          "description": "Verify all existing tests still pass",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm test -- --run",
            "expected": "All tests pass"
          },
          "status": "pending",
          "notes": "Run full test suite to ensure no regressions"
        },
        {
          "id": "subtask-4-3",
          "description": "End-to-end verification of image proxy flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Start dev server with npm run dev",
              "Open http://localhost:3000 in browser",
              "Configure a news widget with an image-containing feed",
              "Verify images load through the proxy (check Network tab)",
              "Verify broken images show fallback UI",
              "Verify no console errors"
            ]
          },
          "status": "pending",
          "notes": "Manual verification step - document results"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 10,
    "services_involved": ["main"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-2-backend-proxy", "phase-3-frontend-component"],
          "reason": "Both depend only on phase-1-backend-infrastructure, no file conflicts"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.3x faster than sequential"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 001 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "phase-3-frontend-component",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": true,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New FeedImage component has test coverage",
      "PHP proxy validates URLs to prevent SSRF",
      "Images from hotlink-protected sources load successfully",
      "Failed images show graceful fallback UI",
      "No console errors when images fail to load"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Type Check",
        "command": "npx tsc --noEmit",
        "expected_outcome": "No type errors",
        "type": "lint",
        "required": true,
        "blocking": true
      },
      {
        "name": "PHP Syntax Check",
        "command": "php -l api/feeds/image-proxy.php",
        "expected_outcome": "No syntax errors detected",
        "type": "lint",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests",
        "command": "npm test -- --run",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Security - SSRF Prevention",
        "command": "grep -E 'filter_var|CURLOPT_REFERER|private.*IP' api/feeds/image-proxy.php",
        "expected_outcome": "URL validation and private IP checks present",
        "type": "security",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk due to server-side URL fetching. Security validation for SSRF prevention is critical. Unit tests verify component behavior, integration tests verify proxy functionality."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["npm test -- --run"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["php -l api/feeds/image-proxy.php"],
      "services_to_test": ["main"]
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": ["news-widget-with-images", "image-proxy-caching"]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000",
          "checks": [
            "News widget renders with images",
            "Images load through /api/feeds/image-proxy.php",
            "Broken images show fallback (bullet point)",
            "No console errors related to images"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "filesystem_verification": {
      "required": true,
      "checks": [
        {
          "path": "api/cache/images/",
          "check": "directory exists and is writable"
        },
        {
          "path": "api/cache/images/",
          "check": "cached images stored with hash filenames after use"
        }
      ]
    }
  },
  "qa_signoff": null
}
